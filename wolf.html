<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width">
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/5.5.6/firebase.js"></script>
<script src="script.js"></script>
<script>
    /*
    結束後獎勵分配 OK

    使用道具扣錢 OK
    其他帳號明細查尋(看戰績)
    
DB 資料庫排序
DB 資料庫分頁


對話訊息篩選day

*/


function Main()
{
    localStorage.kfs = localStorage.kfs||'{}';
    var _tmp = JSON.parse(localStorage.kfs);
    System.member = _tmp.wolf||{};

    ServerTime();

    if(System.member.account===undefined)
    {
        var _t = setInterval( function(){
        if(System.SerialNumber!==undefined && System.SerialNumber!==null)//ServerTime function set value
            {
                clearInterval(_t);

                RegisterMemberChar();
                MenuLi();
                MenuClick("char_info","close");
            }
        },10);
    }
    else
    {
        DB.ref("/member/"+ System.member.account ).once( "value",
            function(member){
                member = member.val();
                if(member===null)
                {
                    delete localStorage.kfs;
                    location.reload();
                    return;
                }
                if(member.password!==System.member.password)
                {
                    delete localStorage.kfs;
                    location.reload();
                    return;
                }

                DB.ref("/member/"+ System.member.account ).update( {"time_last":firebase.database.ServerValue.TIMESTAMP} );
                DB.ref("/char/"+ System.member.account ).update( {"time_last":firebase.database.ServerValue.TIMESTAMP} );


                DB.ref("/char/"+ System.member.account ).once( "value",_c=>{
                    System.char = _c.val();

                    MenuLi();
                    if(System.char.name==="") MenuClick("char_info","close");

                    if(System.char.game_sn!=="")
                    {
                        System.content = System.char.game_sn;
                        MenuClick("game_list","close");
                    }
                });
            }
        );
    }

    
}

function MenuLi()
{
    var time = document.createElement("div");
    time.id = "Time";
    time.addEventListener("click",function(){
        document.querySelectorAll("#Menu ul>div").forEach(function(div,idx){
            div.style.height = "0px";
        });
    });


    var div = document.createElement("div");
    div.id = "Menu";
    var ul = document.createElement("ul");
    var list = {
        "account":{"name":"帳號管理"},
        "char_info":{"name":"玩家資訊"},
        "char_list":{"name":"玩家清單"},
        "game_create":{"name":"建立遊戲"},
        "game_list":{"name":"遊戲列表"}
    }

    if(System.char.name==="")
    {
        list = {
            "account":{"name":"帳號管理"},
            "char_info":{"name":"玩家資訊"},
        }
    }

    for(var i in list)
    {
        var li = document.createElement("li");
        li.id = i;
        li.innerHTML = list[i].name;

        ul.appendChild(li);

        var li_div = document.createElement("div");
        li_div.id = i;    
        ul.appendChild(li_div);
    }

    div.appendChild(ul);

    document.body.appendChild(time);
    document.body.appendChild(div);

    document.querySelectorAll("#Menu ul li").forEach(function(li){

        li.addEventListener("click",function(){MenuClick(li.id,"close");} );
        
    });

}


function MenuClick(id,act)
{
    if(act=="close")
    {
        document.querySelectorAll("#Menu ul>div").forEach(function(div,idx){
            div.style.height = "0px";
        });

        setTimeout(function(){
            MenuClick(id,"open");
        },0);
        return;
    }
    
    var div = document.createElement("div");
    div.id = "Main";

    var menu = {};

    if(id=="account")
    {
        menu = {
            "account":{
                "type":"text",
                "span":"帳號序號",
                "disabled":"disabled",
                "value":System.member.account},
            "password":{
                "type":"text",
                "span":"帳號繼承碼",
                "disabled":"disabled",
                "value":System.member.password||""},
            "button":{
                "type":"button",
                "value":"更新繼承碼",
                "span":"",
                "event":{"click":EditAccount}},
            "button2":{
                "type":"button",
                "value":"繼承已有帳號",
                "span":"",
                "event":{"click":OldAccount}},
            "button3":{
                "type":"button",
                "value":"清除帳號資料",
                "span":"",
                "event":{"click":DelAccount}}
        }

        RowMake(menu,div,id);
    }

    if(id=="char_info")
    {
        System.char_bonus_set = JSON.parse(JSON.stringify(System.char));

        var str = System.c_s_word;


        for(var i in System.char_default)
        {
            if(str[i]===undefined) continue;

            menu[i] = {
                "type":"text",
                "span":str[i],
                "disabled":"disabled",
                "value":JSON.parse(JSON.stringify(System.char[i])),
                "class":"number"
            }

            if(i=="item") menu[i].value = System.char.item.money;              
        }


        menu.name.class = "";
        if(System.char.name==="")
        {
            delete menu.name.disabled;
        }

        if(System.char.name==="")
        {
            menu["button"] = {
                "type":"button",
                "value":"決定角色名稱",
                "span":"",
                "event":{"click":EditChar}
            }

            var _div = document.createElement("div");
            _div.className = "info";
            _div.innerHTML = "請輸入角色名稱並儲存開始遊戲<BR>角色名稱日後不可更改<BR>或在【帳號管理】使用序號及繼承碼繼承已有帳號";
            div.appendChild(_div);
        }
        RowMake(menu,div,id);
    }




    if(id=="char_list")
    {
        DB.ref("/char/").once( "value",function(_r){
            _r = _r.val();
            
            var title = {
                "0":{
                    "title":"玩家名稱",
                    "html":"name_account"},
                "2":{
                    "title":"最後活動時間",
                    "html":"time_last_word"}
            };
            var list = [];


            for(var key in _r)
            {
                var char = _r[key];

                if(char.name==="") continue;

                var list_idx = list.length;
                
                list[ list_idx ] = char;

                list[ list_idx ]["name_account"] = 
                "【"+char.name + "】";

                list[ list_idx ]["time_last_word"] = 
                DateFormat( new Date(char.time_last) );
            }
            

            list = SortData(list,"time_last",1);

            ListMake(title,list,div,id);
        });

        return;
    }


    
    if(id=="game_create")
    {
        for(var i in System.create_game_row)
        {
            menu[i] = {
                "type":System.create_game_row[i].type,
                "span":System.create_game_row[i].name,
                "class":System.create_game_row[i].type,
                "value":System.create_game_row[i].value||"",
            }            
        }

        DB.ref("/char/"+System.member.account).once( "value",function(char){
            System.char = char.val();

            if(System.char.game_sn==="")
            {       
                menu["button"] = {
                    "type":"button",
                    "value":"建立遊戲",
                    "span":"",
                    "event":{"click":function(){
                        GameFunc("create");
                    }}
                };
            }
            else
            {
                menu["button"] = {
                    "type":"button",
                    "value":"已加入遊戲，不可建立新遊戲，前往已加入遊戲",
                    "span":"",
                    "event":{"click":function(){
                        System.content = System.char.game_sn;
                        MenuClick("game_list","close");
                    }}
                };
            }

            RowMake(menu,div,id);

        });
    }


    if(id=="game_list")
    {
        if(System.content!=="list")
        {

            var _div = document.createElement("div");
            _div.className = "info btn";
            _div.innerHTML = "回到列表";
            _div.addEventListener("click",function(){
                System.content = "list";
                MenuClick(id,"open");
            });
            div.appendChild(_div);

            var _div = document.createElement("div");
            _div.className = "info btn";
            _div.innerHTML = "前往對話區";
            _div.addEventListener("click",function(){
                location.href = "chat.html";
                return;
            });
            div.appendChild(_div);


            var _div = document.createElement("div");
            _div.className = "info";
            _div.innerHTML = "【"+System.content+"】";
            div.appendChild(_div);


            DB.ref("/game/"+System.content).once( "value",function(game){
                game = game.val();

                DB.ref("/char/"+System.member.account).once( "value",function(char){

                    System.char = char.val();
                    
                    if(game===null)
                    {
                        System.content = "list";

                        System.char.game_sn = "";
                        System.char.game_day = "";
                        System.char.game_time = "";
                        System.char.game_end = "";

                        DB.ref("/char/"+System.member.account).update( System.char );
                        MenuClick(id,"close");
                        return;
                    }
                    sessionStorage.game = JSON.stringify(game);


                    if(System.char.game_sn!="")
                    {
                        System.char.game_day = game.nowday;
                        System.char.game_time = game.nowtime;
                        System.char.game_end = game.end;

                        DB.ref("/char/"+System.member.account).update(System.char);
                    }
                    
                    if(game.end==="start") GameStart(div,game,id);
                    if(game.end==="end") GameEnd(div,game,id);

                    var char_list_self = game.char_list[ System.member.account ] || {};

                    if(game.end=="ready")
                    {
                        var _div = document.createElement("div");
                        _div.className = "info";
                        _div.innerHTML = "";

                        if(char_list_self.nickname!==undefined)
                            _div.innerHTML += "此局的角色名稱為【"+char_list_self.nickname+"】<BR>";

                        _div.innerHTML += "目前加入玩家【"+Object.keys(game.char_list).length+"】名，還差【"+(game.config.char_count-Object.keys(game.char_list).length)+"】名玩家<BR>按下【準備完成】鈕等待房主【開始遊戲】";

                        div.appendChild(_div);


                        if(System.char.game_sn==="")
                        {
                            menu["button"] = {
                                "type":"button",
                                "value":"加入遊戲",
                                "span":"",
                                "event":{"click":function(){
                                    GameFunc("join");
                                }}
                            };
                        }

                        if(game.char_create==System.member.account)
                        {
                            menu["start_button"] = {
                                "type":"button",
                                "value":"開始遊戲",
                                "span":"",
                                "event":{"click":function(){
                                    GameFunc("start",game.sn);
                                }}
                            };
                        }

                        if(System.char.game_sn===game.sn)
                        {
                            menu["button2"] = {
                                "type":"button",
                                "value":"退出此遊戲",
                                "span":"",
                                "event":{"click":function(){
                                    GameFunc("quit",System.member.account);
                                }}
                            };

                            if(System.member.account!=game.char_create)
                            {
                                var _ready_btn = "準備完成";
                                if(char_list_self.ready=="yes")
                                    _ready_btn = "等待房主開始遊戲";


                                menu["button3"] = {
                                    "type":"button",
                                    "value":_ready_btn,
                                    "span":"",
                                    "event":{"click":function(){
                                        GameFunc("start",game.sn);
                                    }}
                                };
                            }
                        }

                        if(System.char.game_sn!=game.sn && System.char.game_sn!="")
                        {
                            if(game.end=="ready")
                            menu["button3"] = {
                                "type":"button",
                                "value":"已加入其他遊戲，前往已加入遊戲",
                                "span":"",
                                "event":{"click":function(){
                                    System.content = System.char.game_sn;
                                    MenuClick("game_list","close");
                                }}
                            };
                        }

                        RowMake(menu,div,id);
                        div.appendChild( document.createElement("p") );
                    }

                    if(game.end=="ready")
                    {

                        var _div = document.createElement("div");
                        _div.className = "info";
                        _div.innerHTML = "購買道具，目前持有金錢【"+System.char.item.money+"】";
                        div.appendChild(_div);

                    
                        item = game.item;

                        var title = [
                            {
                                "title":"道具",
                                "html":"name"
                            },
                            {
                                "title":"價錢",
                                "html":"money"
                            },
                            {
                                "title":"購買",
                                "html":"buy",
                                "id":"id",
                                "class":"btn",
                                "event":{"click":function(){
                                    for(var n in item)
                                    {
                                        if(n==this.id)
                                        {
                                            if(System.char.item.money<item[n].money)
                                            {
                                                alert("金錢不足");
                                                return;
                                            }
                                        }
                                    }

                                    BuyItem(this.id);
                                }}
                            }
                        ];
                        var list = [];
                        for(var key in item)
                        {
                            var idx = list.length;

                            list[idx] = item[key];
                            list[idx].name = key;
                            list[idx].id = key;

                            if(game.char_list[System.member.account])
                            {
                                if(game.char_list[System.member.account].item[key]!==undefined)
                                    list[idx].buy = "已購買";
                                else
                                    list[idx].buy = "購買";
                            }
                            else
                            {
                                delete title["2"];
                            }
                        }

                        ListMake(title,list,div,id);
                        div.appendChild( document.createElement("p") );
                    }

                    var title = [];

                    title = [
                    {
                        "title":"玩家列表",
                        "html":"nickname_word",
                        "id":"id",
                        "class":"btn vote",
                        "event":{"click":function(){
                            if(System.char.action==="vote")
                            {
                                if(confirm("確定要投票給"+this.innerHTML+"嗎?")===true)
                                {
                                    clearInterval( System.focus_timer);
                                    Vote(this.id);
                                    
                                }
                            }

                            var action_word = {
                                "wolf":"咬殺",
                                "divine":"占卜",
                                "guard":"守衛",
                            };

                            if(System.char.action!=="vote" && 
                            System.char.action!==undefined && 
                            System.char.action!=="")
                            {
                                if(confirm("確定要"+action_word[ game.char_list[System.member.account].job ]+this.innerHTML+"嗎?")===true)
                                {
                                    clearInterval( System.focus_timer);
                                    Vote(this.id);
                                }
                            }
                        }}
                    },
                        {
                            "title":"踢除玩家",
                            "html":"quit",
                            "id":"id",
                            "class":"btn",
                            "event":{"click":function(){
                                GameFunc("quit",this.id);
                            }}
                        },
                        {
                            "title":"準備狀態",
                            "html":"ready_status",
                        }
                    ];
                    

                    if(game.char_create!=System.member.account || 
                    game.end!=="ready")
                    {
                        title.splice(1,1);
                    }

                    if(game.end!=="ready")
                    {
                        title.splice(1,1);
                    }


                    if(game.char_list[ System.member.account ]!==undefined)
                    if( game.char_list[ System.member.account ].job==="divine" ||
                    game.char_list[ System.member.account ].job==="psychic")
                    {
                        var _divine_psychic = {
                            "divine":"占卜結果",
                            "psychic":"靈媒結果"
                        }

                        title[ title.length ] = 
                        {
                            "title":_divine_psychic[ game.char_list[ System.member.account ].job ],
                            "class":"btn",
                            "html":"_divine_psychic",
                        };
                    }

                    if(game.end==="end")
                    {
                        title[ title.length ] = 
                        {
                            "title":"職業",
                            "class":"btn",
                            "html":"job_word",
                        };
                    }

                    

                    var list = [];
                    for(var account in game.char_list)
                    {
                        var list_idx = list.length;

                        list[ list_idx ] = game.char_list[account];
                        list[ list_idx ].id = account;


                        if(game.char_list[account].dead.status==="dead")
                        {
                            var memo = "";
                            memo += "第"+game.char_list[account].dead.day+"天";

                            if(game.char_list[account].dead.type==="vote")
                                memo += "被村民吊死";
                            else
                                memo += "被人狼咬死";

                            list[ list_idx ].nickname_word = '<s>【'+game.char_list[account].nickname+'】(死亡)</s><BR>'+memo;
                        }
                        else
                        {
                            list[ list_idx ].nickname_word = "【"+game.char_list[account].nickname+"】";
                        }

                        if(game.end==="end")
                        {
                            list[ list_idx ].nickname_word += "<BR>玩家帳號【"+game.char_list[account].name+"】";
                        }


                        list[ list_idx ].quit = "踢除玩家";
                        
                        if(account==game.char_create)
                        {
                            list[ list_idx ].quit = "房主";
                            list[ list_idx ].ready_status = "房主";
                        }
                        else
                        {
                            list[ list_idx ].ready_status = (game.char_list[account].ready=="yes")?"準備完成":"<span class=red>尚未準備</span>";
                        }

                        list[ list_idx ]._divine_psychic = "無";

                        if(char_list_self!==undefined)
                        if(char_list_self.job==="divine")
                        {
                            for(var _day in char_list_self.divine)
                            {
                                if(char_list_self.divine[_day].value!==account) continue;

                                if(char_list_self.divine[_day].value=="" || 
                                char_list_self.divine[_day].value===undefined) continue;

                                if(game.nowday<=_day && game.nowtime=="wolf") continue;


                                if(char_list_self.dead.status!="dead" || _day<char_list_self.dead.day)
                                {
                                    if( game.char_list[ char_list_self.divine[_day].value ].job==="wolf" )
                                        list[ list_idx ]._divine_psychic = "第"+_day+"天占卜結果<BR>【狼人】";
                                    else
                                        list[ list_idx ]._divine_psychic = "第"+_day+"天占卜結果<BR>【人類】";
                                }
                                
                            }
                        }

                        if(char_list_self!==undefined)
                        if( char_list_self.job==="psychic")
                        {
                            for(var _day in char_list_self.psychic)
                            {
                                if(char_list_self.psychic[_day].value!==account) continue;

                                if(char_list_self.psychic[_day].value=="" || 
                                char_list_self.psychic[_day].value===undefined) continue;

                                if(char_list_self.dead.status!="dead" || _day<char_list_self.dead.day)
                                {
                                    if( game.char_list[ char_list_self.psychic[_day].value ].job==="wolf" )
                                        list[ list_idx ]._divine_psychic = "第"+_day+"天靈媒結果<BR>【狼人】";
                                    else
                                        list[ list_idx ]._divine_psychic = "第"+_day+"天靈媒結果<BR>【人類】";
                                }
                                
                            }
                        }
                        
                        if(account.toString()===System.member.account || 
                        game.char_list[account].dead.status==="dead")
                        {
                            list[ list_idx ].class = "btn";
                            list[ list_idx ].event = "remove";
                        }

                        if(game.end==="end")
                        {
                            list[ list_idx ].job_word = System.job_word[ game.char_list[ account ].job ];
                        }

                    };
                    
                    ListMake(title,list,div,id);
                    div.appendChild( document.createElement("p") );


                    
                    menu = [];
                    for(var i in System.create_game_row)
                    {
                        menu[i] = {
                            "type":System.create_game_row[i].type,
                            "span":System.create_game_row[i].name,
                            "disabled":"disabled",
                            "class":System.create_game_row[i].type,
                            "value":game.config[i]||game[i],
                        }
                        if(i=="game_nickname")
                        {
                            menu[i].value = "";
                            delete menu[i].disabled;
                        }

                        if(i=="game_password" && 
                        game.char_create!=System.member.account && 
                        game.sn!=System.char.game_sn)
                        {
                            menu[i].value = "";
                            delete menu[i].disabled;
                        }

                    }

                    if(System.char.game_sn==game.sn || game.end=="end")
                        delete menu.game_nickname;
                    

                    if(game["game_password"]==="")
                        menu.game_password = {"type":"hidden","span":""};
                    

                    RowMake(menu,div,id);
                    div.appendChild( document.createElement("p") );
                
                });

            });
        }
        else//if(System.content!=="list")
        {


            DB.ref("/game/").once( "value",function(game){

                game = game.val();
                
                var title = {
                    "0":{
                        "title":"遊戲名稱",
                        "html":"name",
                        "class":"btn",
                        "id":"sn",
                        "event":{"click":function(){
                            System.content = this.id;
                            MenuClick(id,"open");
                            return;
                        }}
                    },
                    "1":{
                        "title":"開始時間",
                        "html":"time_create"
                    },
                    
                };
                var list = [];
                var end_word = {
                    "ready":"等待玩家中",
                    "start":"進行中",
                    "end":"已結束",
                }

                for(var key in game)
                {
                    var list_idx = list.length;
                    
                    list[ list_idx ] = game[key];

                    list[ list_idx ].name = 
                    "【"+game[key].name + "】<BR>【"+game[key].sn+"】<BR>【<span class=red>"+end_word[ game[key].end ]+"</span>】";

                    list[ list_idx ].time_create = 
                    DateFormat( new Date(game[key].time_last),"<BR>" );
                }

                list = SortData(list,"time_last",1);


                ListMake(title,list,div,id);
            });
        }

    }//if(id=="game_list")
}


function GameFunc(act,id = "")
{   
    if(act=="start")
    {
        DB.ref("/game/"+id).once( "value",function(game){
            game = game.val();

            if(game===null)
            {
                System.content = "list";
                MenuClick("game_list","open");
                return;
            }

            if(System.member.account!=game.char_create)
            {
                if(game.char_list[ System.member.account ].ready!="yes")
                    game.char_list[ System.member.account ].ready = "yes";
                else
                    game.char_list[ System.member.account ].ready = "no";

                DB.ref("/game/"+id).set( game );
                
                MenuClick("game_list","close");
                return;
            }
            else
            {
                game.char_list[ System.member.account ].ready = "yes";
            }

            var char_list = [];
            var check_ready = true;
            var use_item_list = {};
            var use_item_continue_job = [];
            for(var account in game.char_list)
            {
                var idx = char_list.length;
                char_list[ idx ] = game.char_list[account];
                char_list[ idx ].id = account;

                if(game.char_list[account].ready!="yes") 
                    check_ready = false;

                
                var item = game.char_list[account].item;

                for(var item_name in item)
                {
                    if(item_name=="money") continue;

                    if(item[item_name].money>item.money || game.config[item[item_name].job+"_count"]==0)
                    {
                        delete char_list[ idx ].item[item_name];
                    }
                    else
                    {
                        use_item_list[ item_name ] = use_item_list[ item_name ]||[];
                        use_item_list[ item_name ].push(account);
                    }
                }
            }
            
            if( parseInt(game.config.char_count)!==Object.keys(game.char_list).length )
            {
                alert("玩家人數不足");
                MenuClick("game_list","close");
                return;
            }

            if(check_ready!=true)
            {
                alert("尚有玩家沒按下準備完成");
                MenuClick("game_list","close");
                return;
            }

            for(var item_name in use_item_list)
            {
                var job = game.item[item_name].job;
                

                var lose_max = 0;
                var _set_job = [];
                if(use_item_list[item_name].length==1)
                {
                    _set_job = use_item_list[item_name];
                }
                else
                {
                    for(var account of use_item_list[item_name])
                    {
                        if(lose_max<=
                        game.char_list[ account ].human_lose - 
                        (-1)*game.char_list[ account ].wolf_lose)
                        {
                            lose_max = 
                            game.char_list[ account ].human_lose - 
                            (-1)*game.char_list[ account ].wolf_lose;
                        }
                    }
                    for(var account of use_item_list[item_name])
                    {
                        if(lose_max == game.char_list[ account ].human_lose - 
                        (-1)*game.char_list[ account ].wolf_lose)
                        {
                            _set_job.push(account);
                        }
                    }

                    Shuffle(_set_job);
                }

                console.log( JSON.parse(JSON.stringify(_set_job)) );


                for(var _config_job_count=0;
                    _config_job_count<game.config[job+"_count"];
                    _config_job_count++)
                {
                    if(_set_job.length==0)
                    {
                        break;
                    }
                    game.config[job+"_count"]--;

                    var account = _set_job.pop();
                    game.char_list[ account ].job = job;
                    game.char_list[ account ].item.money-=game.item[item_name].money;

                    DB.ref("/char/"+account).update( 
                        {"item":
                            {"money":game.char_list[ account ].item.money}
                        }
                    );

                    var array_idx = 0;
                    for(var _a in char_list)
                    {
                        if(char_list[_a].id==account) char_list.splice(array_idx,1);
                        array_idx++;
                    }
                }
            }

            
            for(var idx in game.config)
            {
                if(idx=="char_count") continue;
                if(use_item_continue_job.indexOf(idx.split("_")[0])!=-1) continue;

                for(var i=0;i<game.config[idx];i++)
                {
                    Shuffle(char_list);
                    
                    var _char = char_list.pop();

                    _char.job = idx.split("_")[0];
                    
                    game.char_list[ _char.id ] = _char;
                }
            }
            
            
            var for_max = char_list.length;
            if(for_max!=0)
            for(var i=0;i<for_max;i++)
            {
                var _char = char_list.pop();
                _char.job = "human";

                game.char_list[ _char.id ] = _char;
            }
            delete game.config;

            console.log(game.char_list);
            console.log(game);

            game.end = "start";
            game.nowtime = "human";
            DB.ref("/game/"+id).update( game );

            alert("遊戲開始");
            MenuClick("game_list","close");
            return;
        });
    }


    if(act=="create")
    {
        var new_game = {"config":{}};
        var idx = 0;

        for(var i in System.create_game_row)
        {
            new_game.config[ i ] = document.querySelectorAll("textarea,input[type=text],[type=number]")[ idx ].value;

            if(i!="game_password")
            if(new_game.config[ i ]==="" || new_game.config[ i ]===undefined)
            {
                alert("必填欄位不可空白");
                MenuClick("create","open");
                return;
            }

            idx++;
        }
        new_game.sn = System.SerialNumber;
        new_game.end = "ready";
        
        new_game.name = new_game.config.name;
        new_game.game_memo = new_game.config.game_memo;
        new_game.game_password = new_game.config.game_password;        
        var game_nickname = new_game.config.game_nickname;

        delete new_game.config.name;
        delete new_game.config.game_memo;
        delete new_game.config.game_password;
        delete new_game.config.game_nickname;

        if( parseInt(new_game.config.char_count) < 
            parseInt( 
                parseInt(new_game.config.wolf_count) + 
                parseInt(new_game.config.divine_count) + 
                parseInt(new_game.config.guard_count) +
                parseInt(new_game.config.psychic_count))
        )
        {
            alert("人數設定錯誤");
            return;
        }

        console.log(new_game.config);
        for(var idx in new_game.config)
        {
            if( Number.isNaN( parseInt(new_game.config[idx]) )===true )
            {
                alert("人數設定錯誤");
                return;
            }
        }

        new_game.config.human_count = new_game.config.char_count - parseInt( 
                parseInt(new_game.config.wolf_count) + 
                parseInt(new_game.config.divine_count) + 
                parseInt(new_game.config.guard_count) +
                parseInt(new_game.config.psychic_count));


        new_game.char_list = {};
        new_game.char_list[ System.member.account ] = System.char;
        new_game.char_list[ System.member.account ].nickname = game_nickname;

            
        new_game.char_create = System.member.account;
        new_game.char_last = System.member.account;
        new_game.time_create = firebase.database.ServerValue.TIMESTAMP;
        new_game.time_last = firebase.database.ServerValue.TIMESTAMP;
        new_game.nowday = "0";
        new_game.nowtime = "";//wolf夜晚,human白天
        

        System.char.game_sn = new_game.sn;
        System.char.game_day = "0";
        System.char.game_time = "";
        System.char.game_end = "";

        DB.ref("/item/").once( "value",function(item){
            item = item.val();

            new_game.item = item;

            DB.ref("/char/"+System.member.account).update(System.char);
            DB.ref("/game/"+new_game.sn).set( new_game );

            alert("遊戲建立完成");
            MenuClick("game_list","close");
            return;
        });        
    }


    if(act=="quit")
    {
        DB.ref("/game/"+System.content).once( "value",function(game){
            game = game.val();

            if(game===null)
            {
                System.content = "list";
                MenuClick("game_list","open");
                return;
            }

            if(System.char.game_day.toString()!==game.nowday.toString() || 
            System.char.game_time.toString()!==game.nowtime.toString() || 
            System.char.game_end.toString()!==game.end.toString())
            {
                location.reload();
                return;
            }


            if(game.char_create!==System.member.account && 
                id!==System.member.account)
            {
                MenuClick("game_list","close");
                return;
            }
            

            if(id===System.member.account && 
                game.char_create===System.member.account)
            {
                if(confirm("遊戲建立者離開會解散全部玩家\n確定要繼續嗎?")===true)
                {
                    DB.ref("/game/"+game.sn).remove();
                    System.char.game_sn = "";
                    DB.ref("/char/"+id).update( {"game_sn":""} );
                    MenuClick("game_list","open");
                    return;
                }
                return;
            }


            delete game.char_list[ id ];
            
            DB.ref("/char/"+id).update( {"game_sn":""} );
            DB.ref("/game/"+game.sn).update( game );
            
            alert("退出遊戲成功");
            MenuClick("game_list","close");
            return;
        });
    }

    if(act=="join")
    {
        DB.ref("/game/"+System.content).once( "value",function(game){
            game = game.val();

            if(game===null)
            {
                System.content = "list";
                MenuClick("game_list","open");
                return;
            }


            if( parseInt(game.config.char_count)===Object.keys(game.char_list).length )
            {
                alert("此局人數已滿");
                return;
            }

            var game_password = document.querySelector("input#game_password").value;
            var game_nickname = document.querySelector("input#game_nickname").value;
            
            if(game_nickname==="")
            {
                alert("此局角色名稱不可空白");
                return;
            }

            if(game_password!=game.game_password)
            {
                alert("密碼錯誤,無法進入此遊戲");
                return;
            }
            for(var key in game.char_list)
            {
                if(game_nickname===game.char_list[key].nickname)
                {
                    alert("此局名稱已被使用");
                    return;
                }
                if(key===System.member.account)
                {
                    alert("此帳號已加入此遊戲");
                    return;
                }
            }

            game.char_list[ System.member.account ] = System.char;
            game.char_list[ System.member.account ].nickname = game_nickname;

            game.char_last = System.member.account;
            game.time_last = firebase.database.ServerValue.TIMESTAMP;

            System.char.game_sn = game.sn;

            
            DB.ref("/char/"+System.member.account).update(System.char);
            DB.ref("/game/"+game.sn).update( game );


            if( parseInt(game.config.char_count)===Object.keys(game.char_list).length )
            {
                //GameFunc("start",game.sn);
                //return;
            }

            alert("加入遊戲成功");
            MenuClick("game_list","close");
        });
        return;
    }
}





function GameStart(div,game,id)
{
    var vote_count = 0,
        pass_count = 0,
        pass_now = "",
        now_vote = "",
        now_vote_char = "",
        now_action = "",
        now_action_char = "",
        wolf_list = [];
    var action_word = {
                "wolf":"咬殺",
                "divine":"占卜",
                "guard":"守衛",
                //"psychic":"靈媒"
            };
    var char_list_self = game.char_list[ System.member.account ];

    for(var account in game.char_list)
    {
        game.char_list[account].vote[game.nowday] = game.char_list[account].vote[game.nowday]||{};
        game.char_list[account].pass[game.nowday] = game.char_list[account].pass[game.nowday]||{};

        if(account===System.member.account)
            now_vote = game.char_list[account].vote[game.nowday].value||"";
        

        if( game.char_list[account].vote[game.nowday].value!=="" && 
        game.char_list[account].vote[game.nowday].value!==undefined) 
            vote_count++;
        
        if( game.char_list[account].pass[game.nowday].value!=="" && 
        game.char_list[account].pass[game.nowday].value!==undefined) 
            pass_count++;

        if( game.char_list[account].job==="wolf")
            wolf_list.push("【"+game.char_list[account].nickname+"】");
    }

    
    
    var _div = document.createElement("div");
    _div.className = "info";

    if(char_list_self!==undefined)
    {
        _div.innerHTML = "此局的名稱為【"+char_list_self.nickname+"】<BR>此局的職業為【"+System.job_word[ char_list_self.job ]+"】<BR>";

        if(char_list_self.dead.status=="dead")
            _div.innerHTML += "你已經死亡<BR>";

        if(char_list_self.job==="wolf")
            _div.innerHTML += "全部人狼："+wolf_list.join("")+"<BR>";
    }
    else
    {
        _div.innerHTML = "觀戰模式<BR>";
    }

    if(char_list_self!==undefined)
    if(game.nowday!=="0")
    if(game.nowtime==="human")//白天
    {
        char_list_self.vote[game.nowday] = char_list_self.vote[game.nowday]||{};
        now_vote = char_list_self.vote[game.nowday].value;

        if(now_vote!==undefined && now_vote!=="" && now_vote!="pass")
            now_vote_char = game.char_list[ now_vote ].nickname;
        
        if(now_vote=="pass")
            now_vote_char = "pass";

        _div.innerHTML += "已投票人數：【"+vote_count+"】<BR>";

        if( game.char_list[ System.member.account ].dead.status!="dead" )
        {
            if(now_vote_char!=="" && now_vote_char!="pass")
                _div.innerHTML += "第"+game.nowday+"天的投票對象為【"+now_vote_char+"】";
            else if(now_vote_char=="pass")
                _div.innerHTML += "第"+game.nowday+"投票天PASS";
            else
                _div.innerHTML += "第"+game.nowday+"天尚未投票";
        }
    }
    else if(game.nowtime==="wolf")
    {
        _div.innerHTML += "已行動結束人數：【"+pass_count+"】<BR>";
        
        if( game.char_list[ System.member.account ].dead.status!="dead" )
        {
            char_list_self.pass[game.nowday] = char_list_self.pass[game.nowday]||{};
            pass_now = char_list_self.pass[game.nowday].value;

            if(pass_now===undefined || pass_now==="")
            {
                _div.innerHTML += "你尚未行動結束<BR>";
            }
            else
            {
                _div.innerHTML += "你已經行動結束<BR>";
            }


            if(game.char_list[System.member.account].job!=="human" && 
            game.char_list[System.member.account].job!=="psychic")
            {
                game.char_list[System.member.account][game.char_list[System.member.account].job][game.nowday] = game.char_list[System.member.account][game.char_list[System.member.account].job][game.nowday]||{};

                now_action = game.char_list[System.member.account][game.char_list[System.member.account].job][game.nowday].value;

                if(now_action!==undefined && now_action!=="")
                    now_action_char = game.char_list[ now_action ].nickname;

                if(now_action_char!=="")
                    _div.innerHTML += "第"+game.nowday+"天"+action_word[ game.char_list[System.member.account].job ]+"的目標為【"+now_action_char+"】";
                else
                    _div.innerHTML += "第"+game.nowday+"天"+action_word[ game.char_list[System.member.account].job ]+"的目標尚未選擇";
            }
        }
    }

    div.appendChild(_div);

    if(char_list_self!==undefined)
    if(game.nowday==="0")
    {
        var title = [
            {
            "title":"先迎來夜晚",
            "html":"",
            "id":"id",
            "title_class":"btn",
            "title_event":{"click":function(){
                System.char.action = "vote";
                Vote("wolf");
            }}
            },
            {
            "title":"先迎來白天",
            "html":"",
            "id":"id",
            "title_class":"btn",
            "title_event":{"click":function(){
                System.char.action = "vote";
                Vote("human");
            }}
            },
            {
            "title":"PASS",
            "html":"",
            "id":"id",
            "title_class":"btn",
            "title_event":{"click":function(){
                System.char.action = "vote";
                Vote("pass");
            }}       
            }
        ];

        var _day0_word = {
            "wolf":"先迎來夜晚",
            "human":"先迎來白天",
            "pass":"PASS"
        }
        var _div = document.createElement("div");
        _div.className = "info";
        _div.innerHTML = "第一天開始前請先選擇先迎來夜晚或早晨<BR>先迎來夜晚由狼人先咬人，先迎來白天由人類先吊人<BR>已選擇人數：【"+vote_count+"】<BR>";

        if(now_vote!=="")
            _div.innerHTML += "現在選擇：【" + _day0_word[now_vote]+"】";
        else
            _div.innerHTML += "尚未選擇";
        div.appendChild(_div);

        var list = [];
        ListMake(title,list,div,id);
    }
    else
    {
        var nowtime_word = {"wolf":"夜晚","human":"白天"};
        var _div = document.createElement("div");
        _div.className = "info";
        _div.innerHTML = "【第"+game.nowday+"天"+nowtime_word[game.nowtime]+"】";
        div.appendChild(_div);
        div.appendChild( document.createElement("p") );

        if( game.char_list[ System.member.account ].dead.status!="dead" )
        if(game.nowtime==="human")//白天
        {
            var title = [
                {
                "title":"投票",
                "html":"",
                "id":"id",
                "title_class":"btn",
                "title_event":{"click":function(){
                    System.char.action = "vote";
                    alert("點擊玩家列表決定要投票的對象");
                    Focus(".vote");
                }}
                },
                {
                "title":"PASS",
                "html":"",
                "id":"id",
                "title_class":"btn",
                "title_event":{"click":function(){
                    System.char.action = "vote";
                    Vote("pass");
                }}
                }
            ];

            var list = [];
            ListMake(title,list,div,id);
            div.appendChild( document.createElement("p") );
        }
        else if(game.nowtime==="wolf")//晚上
        {
            var title = [];

            title["0"] = 
            {
            "title":"行動結束",
            "html":"",
            "id":"id",
            "title_class":"btn",
            "title_event":{"click":function(){
                System.char.action = "pass";
                Vote("pass");
            }}
            };


            if(action_word[ game.char_list[System.member.account].job ]!==undefined)
            {
                title["1"] = 
                {
                "title":action_word[ game.char_list[System.member.account].job ],
                "html":"",
                "id":"id",
                "title_class":"btn",
                "title_event":{"click":function(){
                    System.char.action = game.char_list[System.member.account].job;
                    alert("點擊玩家列表決定要"+action_word[ game.char_list[System.member.account].job ]+"的對象");

                    if(System.char.action!=="psychic")
                        Focus(".vote");
                    else
                        Focus(".dead");
                }}
                };
            }
            var list = [];
            ListMake(title,list,div,id);
            div.appendChild( document.createElement("p") );
        }

        var title = [];
        var list = [];
        title = [
            {
                "title":"天數",
                "html":"day",
            },
            {
                "title":"活動記錄",
                "html":"log",
            },
        ];
        
        var day0_ary = {
            "wolf":"先迎來夜晚",
            "human":"先迎來白天",
            "pass":"PASS"
        }
        var log = [];
        var log_word = "";
        
        for(var i=0;i<=game.nowday;i++)
        {
            if(game.nowtime=="human" && i==game.nowday)  continue;

            var idx = list.length;
            
            list[ idx ] = {};
            list[ idx ].day = i;
            list[ idx ].log = "";

            log[ i ] = [];
            
            
            for(var _a in game.char_list)
            {
                

                var vote_target = "";
                game.char_list[_a].vote[ i ] = game.char_list[_a].vote[ i ]||{};
                
                if(game.char_list[_a].vote[ i ].value===undefined || 
                    game.char_list[_a].vote[ i ].value=="" || 
                    game.char_list[_a].vote[ i ].value=="pass")
                {
                    vote_target = "未投票";
                    if(game.char_list[_a].vote[ i ].value=="pass")
                        vote_target = "主動棄票";
                }
                else
                {
                    if(i==0)
                        vote_target = "投給【"+day0_ary[ game.char_list[_a].vote[ i ].value ]+"】";
                    else
                        vote_target = "投給【"+game.char_list[ game.char_list[_a].vote[ i ].value ].nickname+"】";
                }

                list[ idx ].log += "【"+game.char_list[_a].nickname + "】"+vote_target+"<BR>";
                

                log[ i ][ log[i].length ] = {
                    "log_account":_a,
                    "log_word":"【"+game.char_list[_a].nickname + "】"+vote_target+"<BR>",
                    "log_time":game.char_list[_a].vote[ i ].time||0
                };


                if(game.char_list[_a].dead.status=="dead" && i!==0)
                if(game.char_list[_a].dead.day==i)
                {                
                    var dead_type = "被村民吊死";
                    if( game.char_list[_a].dead.type=="wolf" ) dead_type = "被狼人咬死";

                    log[ i ][ log[i].length ] = {
                        "log_account":_a,
                        "log_word":"【"+game.char_list[_a].nickname + "】"+dead_type+"<BR>",
                        "log_time":game.char_list[_a].dead.time-(-1000)||0
                    };
                }



                log[ i ] = SortData(log[ i ],"log_time",0);

                list[ idx ].log = "";
                for(var log_i_idx in log[ i ])
                {

                    if( game.char_list[ log[i][log_i_idx].log_account ].dead.day!==undefined )
                        if( i>game.char_list[ log[i][log_i_idx].log_account ].dead.day ) continue;

                    var _time = " ";

                    if( log[i][log_i_idx].log_time!==0 )
                        _time = DateFormat(new Date(log[i][log_i_idx].log_time),false);

                    list[ idx ].log += _time.split(" ")[1] + log[i][log_i_idx].log_word;
                }
                
            }
        }




        ListMake(title,list,div,id);
        div.appendChild( document.createElement("p") );


    }
}

function GameEnd(div,game,id)
{
    if(System.char.game_sn===game.sn)
    {
        System.char.game_sn = "";
        System.char.game_day = "";
        System.char.game_time = "";
        System.char.game_end = "";

        System.char.game_log = System.char.game_log||{};
        System.char.game_log[ Object.keys(System.char.game_log).length ] = game.sn;


        DB.ref("/char/"+System.member.account).update( System.char );
    }

    var end_word = "",
        _win = "",
        live_count = 0,
        _wolf = 0,
        _human = 0;
        
    for(var account in game.char_list)
    {
        if(game.char_list[account].dead.status==="dead") continue;
        
        live_count++;
        if(game.char_list[account].job==="wolf") _wolf++;
        if(game.char_list[account].job!=="wolf") _human++;
    }
    _win = "人類";
    if(_wolf!==0) _win = "狼人";


    end_word += "遊戲結束，【"+_win+"】的勝利<BR>遊戲進行天數：【"+game.nowday+"】<BR>存活人數：【"+live_count+"】";
    
    var _div = document.createElement("div");
    _div.className = "info";
    _div.innerHTML = end_word;
    div.appendChild(_div);
    div.appendChild( document.createElement("p") );


    var title = [];
    var list = [];
    title = [
        {
            "title":"天數",
            "html":"day",
        },
        {
            "title":"活動記錄",
            "html":"log",
        },
    ];
    
    var day0_ary = {
        "wolf":"先迎來夜晚",
        "human":"先迎來白天",
        "pass":"PASS"
    }
    var log = [];
    var log_word = "";
    
    for(var i=0;i<=game.nowday;i++)
    {
        var idx = list.length;
        
        list[ idx ] = {};
        list[ idx ].day = i;
        list[ idx ].log = "";

        log[ i ] = [];
        
        for(var _a in game.char_list)
        {
            var vote_target = "";
            game.char_list[_a].vote[ i ] = game.char_list[_a].vote[ i ]||{};
            
            if(game.char_list[_a].vote[ i ].value===undefined || 
                game.char_list[_a].vote[ i ].value=="" || 
                game.char_list[_a].vote[ i ].value=="pass")
            {
                vote_target = "未投票";
                if(game.char_list[_a].vote[ i ].value=="pass")
                    vote_target = "主動棄票";
            }
            else
            {
                if(i==0)
                    vote_target = "投給【"+day0_ary[ game.char_list[_a].vote[ i ].value ]+"】";
                else
                    vote_target = "投給【"+game.char_list[ game.char_list[_a].vote[ i ].value ].nickname+"】";
            }

            list[ idx ].log += "【"+game.char_list[_a].nickname + "】"+vote_target+"<BR>";
            

            log[ i ][ log[i].length ] = {
                "log_account":_a,
                "log_word":"【"+game.char_list[_a].nickname + "】"+vote_target+"<BR>",
                "log_time":game.char_list[_a].vote[ i ].time||0
            };

            if( game.char_list[_a].job=="wolf" )
            if(game.char_list[_a].wolf!==undefined && i!==0)
            {
                var wolf_target = "";
                game.char_list[_a].wolf[ i ] = game.char_list[_a].wolf[ i ]||{};
                
                if(game.char_list[_a].wolf[ i ].value===undefined || 
                    game.char_list[_a].wolf[ i ].value=="")
                {
                    wolf_target = "未咬殺";
                }
                else
                {
                    wolf_target = "咬殺【"+game.char_list[ game.char_list[_a].wolf[ i ].value ].nickname+"】";
                }
                
                list[ idx ].log += "【"+game.char_list[_a].nickname + "】"+wolf_target+"<BR>";

                log[ i ][ log[i].length ] = {
                    "log_account":_a,
                    "log_word":"【"+game.char_list[_a].nickname + "】"+wolf_target+"<BR>",
                    "log_time":game.char_list[_a].wolf[ i ].time||0
                };
            }

            if( game.char_list[_a].job=="divine" )
            if(game.char_list[_a].divine!==undefined && i!==0)
            {
                var divine_target = "";
                game.char_list[_a].divine[ i ] = game.char_list[_a].divine[ i ]||{};
                
                if(game.char_list[_a].divine[ i ].value===undefined || 
                    game.char_list[_a].divine[ i ].value=="")
                {
                    divine_target = "未占卜";
                }
                else
                {
                    divine_target = "占卜【"+game.char_list[ game.char_list[_a].divine[ i ].value ].nickname+"】";
                }
                
                list[ idx ].log += "【"+game.char_list[_a].nickname + "】"+divine_target+"<BR>";

                log[ i ][ log[i].length ] = {
                    "log_account":_a,
                    "log_word":"【"+game.char_list[_a].nickname + "】"+divine_target+"<BR>",
                    "log_time":game.char_list[_a].divine[ i ].time||0
                };

            }

            if( game.char_list[_a].job=="guard" )
            if(game.char_list[_a].guard!==undefined && i!==0)
            {
                var guard_target = "";
                game.char_list[_a].guard[ i ] = game.char_list[_a].guard[ i ]||{};
                
                if(game.char_list[_a].guard[ i ].value===undefined || 
                    game.char_list[_a].guard[ i ].value=="")
                {
                    guard_target = "未護衛";
                }
                else
                {
                    guard_target = "護衛【"+game.char_list[ game.char_list[_a].guard[ i ].value ].nickname+"】";
                }
                
                list[ idx ].log += "【"+game.char_list[_a].nickname + "】"+guard_target+"<BR>";

                log[ i ][ log[i].length ] = {
                    "log_account":_a,
                    "log_word":"【"+game.char_list[_a].nickname + "】"+guard_target+"<BR>",
                    "log_time":game.char_list[_a].guard[ i ].time||0
                };
            }


            if(game.char_list[_a].dead.status=="dead" && i!==0)
            if(game.char_list[_a].dead.day==i)
            {                
                var dead_type = "被村民吊死";
                if( game.char_list[_a].dead.type=="wolf" ) dead_type = "被狼人咬死";

                log[ i ][ log[i].length ] = {
                    "log_account":_a,
                    "log_word":"【"+game.char_list[_a].nickname + "】"+dead_type+"<BR>",
                    "log_time":game.char_list[_a].dead.time-(-1000)||0
                };
            }

            log[ i ] = SortData(log[ i ],"log_time",0);

            list[ idx ].log = "";
            for(var log_i_idx in log[ i ])
            {

                if( game.char_list[ log[i][log_i_idx].log_account ].dead.day!==undefined )
                    if( i>game.char_list[ log[i][log_i_idx].log_account ].dead.day ) continue;

                var _time = " ";

                if( log[i][log_i_idx].log_time!==0 )
                    _time = DateFormat(new Date(log[i][log_i_idx].log_time),false);

                list[ idx ].log += _time.split(" ")[1] + log[i][log_i_idx].log_word;
            }
            
        }
        //list[ idx ].log = log;
    }


    console.log(log);


    ListMake(title,list,div,id);
    div.appendChild( document.createElement("p") );

}


function Vote(choice)
{
    var day,
        _target = {"wolf":"","guard":"","divine":"","psychic":""};

    DB.ref("/game/"+System.char.game_sn).once( "value",function(game){
        game = game.val();
        day = game.nowday;

        if(System.char.game_day.toString()!==game.nowday.toString() || 
        System.char.game_time.toString()!==game.nowtime.toString() || 
        System.char.game_end.toString()!==game.end.toString())
        {
            MenuClick("game_list","close");
            return;
        }

        if( game.char_list[ System.member.account ].dead.status=="dead" )
        {
            alert("角色已死亡");
            return;
        }


        //vote 早上投
        //pass 晚上行動結束
        if(System.char.action==="vote" || System.char.action==="pass")
        {
            game.char_list[ System.member.account ][ System.char.action ][ day ] = game.char_list[ System.member.account ][ System.char.action ][ day ]||{};

            game.char_list[ System.member.account ][ System.char.action ][ day ].value = choice;

            var live_count = 0;
            var vote_count = 0;
            var vote = {};
            var max = {};
            for(var account in game.char_list)
            {
                if(game.char_list[account].dead.status!=="dead") live_count++;

                if( game.char_list[account][ System.char.action ][day].value!==undefined && 
                    game.char_list[account][ System.char.action ][day].value!=="")
                {
                    vote_count++;

                    vote[ account ] = game.char_list[account][ System.char.action ][day].value;
                }            
            }

            
            
            //for(var key in vote)
            if( Object.keys(vote).length===live_count)
            {
                for(var key in vote)
                {
                    max[ vote[key] ] = max[ vote[key] ]+1||1;
                }

                var _vote_key = [];
                var _vote_value = [];
                for(var key in max)
                {
                    if(key=="pass") continue;
                    _vote_value.push( max[key] );
                }

                var _vote_value_max = Math.max.apply(null,_vote_value);

                for(var key in max)
                {
                    if(_vote_value_max===max[key])
                        _vote_key.push(key);
                }

                if(game.nowday.toString()==="0")
                {
                    var key;
                    if(_vote_key.length==0)
                    {
                        _vote_key = ["human","wolf"];
                    }
                    if(_vote_key.length>1)
                    {
                        Shuffle(_vote_key);
                    }
                    key = _vote_key.pop();

                    game.nowday = (game.nowday-(-1)).toString();
                    game.nowtime = key;

                    for(var _act in game.char_list)
                    {
                        var _char = game.char_list[_act];
                        _char.vote[game.nowday] = {"value":"","time":""};
                        _char.pass[game.nowday] = {"value":"","time":""};
                        _char.wolf[game.nowday] = {"value":"","time":""};
                        _char.divine[game.nowday] = {"value":"","time":""};
                        _char.psychic[game.nowday] = {"value":"","time":""};
                        _char.guard[game.nowday] = {"value":"","time":""};
                        _char.human[game.nowday] = {"value":"","time":""};
                    }

                    DB.ref("/game/"+System.char.game_sn).update(game);
                }
                else
                {
                    if(game.nowtime=="human")//白天吊人
                    {
                        if(_vote_key.length==0)
                        {
                            
                        }
                        console.log(_vote_key);
                        return;

                        if(_vote_key.length<=2)
                        for(var key in _vote_key)
                        {
                            if(_vote_key[key]=="pass") continue;

                            game.char_list[ _vote_key[key] ].dead = 
                            {
                                "status":"dead",
                                "day":game.nowday,
                                "time":firebase.database.ServerValue.TIMESTAMP,
                                "type":"vote"
                            };
                        }
                    }
                    else//晚上
                    {
                        
                        var psychic_id = "";
                        for(var account in game.char_list)
                        {
                            //console.log( JSON.parse(JSON.stringify( _target)) );

                            if(game.char_list[account][ game.char_list[account].job ][ day ]!==undefined)
                            {
                                if(_target[ game.char_list[account].job ]!="")
                                {
                                    if(game.char_list[account][ game.char_list[account].job ][ day ].value!="")
                                    {
                                        var ary = [
                                            _target[ game.char_list[account].job ],
                                            game.char_list[account][ game.char_list[account].job ][ day ].value
                                        ];

                                        Shuffle(ary);
                                        console.log(ary);

                                        _target[ game.char_list[account].job ] = ary.pop();
                                    }
                                }
                                else
                                {
                                    _target[ game.char_list[account].job ] = game.char_list[account][ game.char_list[account].job ][ day ].value;
                                }
                            }

                            if(game.char_list[account].job==="psychic")
                                psychic_id = account;

                            //撈出今天白天吊死的玩家ID
                            if( game.char_list[account].dead.status==="dead" &&
                            game.char_list[account].dead.day===day &&
                            game.char_list[account].dead.type=="vote" )
                            {
                                _target.psychic = account;
                            }
                        }

                        if(psychic_id!=="")
                        {
                            game.char_list[ psychic_id ].psychic = {};
                            game.char_list[ psychic_id ].psychic[day] = game.char_list[ psychic_id ].psychic[day]||{};
                            game.char_list[ psychic_id ].psychic[day].value = _target.psychic;
                        }


                        if(_target.wolf!==undefined && _target.wolf!=="")
                        if(_target.wolf!==_target.guard)
                        {
                            game.char_list[ _target.wolf ].dead = 
                            {
                                "status":"dead",
                                "day":game.nowday,
                                "time":firebase.database.ServerValue.TIMESTAMP,
                                "type":"wolf"
                            };
                        }
                    }



                    var _human = 0,_wolf = 0;
                    for(var account in game.char_list)
                    {
                        if(game.char_list[account].dead.status==="dead") continue;
                        
                        if(game.char_list[account].job==="wolf") _wolf++;
                        if(game.char_list[account].job!=="wolf") _human++;
                    }

                    if(_human===0 || _wolf===0 || _human===_wolf)
                    {
                        game.end = "end";

                        Award(game,_wolf);
                    }
                    else
                    {
                        if(game.nowtime==="human")
                        {
                            game.nowtime = "wolf";
                        }
                        else
                        {
                            game.nowtime = "human";
                            game.nowday-=(-1);


                            for(var _act in game.char_list)
                            {
                                var _char = game.char_list[_act];
                                _char.vote[game.nowday] = {"value":"","time":""};
                                _char.pass[game.nowday] = {"value":"","time":""};
                                _char.wolf[game.nowday] = {"value":"","time":""};
                                _char.divine[game.nowday] = {"value":"","time":""};
                                _char.psychic[game.nowday] = {"value":"","time":""};
                                _char.guard[game.nowday] = {"value":"","time":""};
                                _char.human[game.nowday] = {"value":"","time":""};
                            }
                        }
                    
                    }

                    DB.ref("/game/"+System.char.game_sn).update( game );
                }            
            }

            DB.ref("/game/"+System.char.game_sn+"/char_list/"+System.member.account+"/"+System.char.action+"/"+day).set({
                "value":choice,
                "time":firebase.database.ServerValue.TIMESTAMP
            });

            

        }//System.char.action==="vote"
        else//各職業晚間使用特殊能力
        {
            DB.ref("/game/"+System.char.game_sn+"/char_list/"+System.member.account+"/"+System.char.action+"/"+day).set({
                "value":choice,
                "time":firebase.database.ServerValue.TIMESTAMP
            });
        }

        System.char.action = "";
        MenuClick("game_list","close");
        return;
    });
}


function Award(game,wolf)
{
    var win = "human",
        char = {};

    if(wolf!=0) win = "wolf";

    DB.ref("/char/" ).once( "value",_c=>{
        char = _c.val();

        for(var _a in game.char_list)
        {
            if( game.char_list[_a].job=="wolf" )
            {
                if(win=="wolf")
                {
                    char[_a].wolf_win+=1;
                    char[_a].item.money+=(10*Object.keys(game.char_list).length);
                }
                else
                {
                    char[_a].wolf_lose+=1;
                    char[_a].item.money+=10;
                }
            }
            else
            {
                if(win=="wolf")
                {
                    char[_a].human_lose+=1;
                    char[_a].item.money+=10;
                }
                else
                {
                    char[_a].human_win+=1;
                    char[_a].item.money+=(10*Object.keys(game.char_list).length)/2;
                }
            }
        }

        DB.ref("/char/").update( char );
    });    
}


function BuyItem(name)
{
    DB.ref("/game/"+System.char.game_sn).once( "value",function(game){
        game = game.val();

        if(game===null)
        {
            System.content = "list";

            System.char.game_sn = "";
            System.char.game_day = "";
            System.char.game_time = "";
            System.char.game_end = "";

            DB.ref("/char/"+System.member.account).update( System.char );
            MenuClick(id,"open");
            return;
        }

        var item = game.item[name];

        var char_item = game.char_list[ System.member.account ].item;

        if(char_item[name]!==undefined)
            delete game.char_list[ System.member.account ].item[ name ];
        else
        {
            for(var key in game.char_list[ System.member.account ].item)
            {
                if(key=="money") continue;
                delete game.char_list[ System.member.account ].item[key];
            }
            
            game.char_list[ System.member.account ].item[ name ] = item;
        }

        DB.ref("/game/"+System.char.game_sn).update(game);

        MenuClick("game_list","close");
        return;
    });
}


function EditAccount()
{
    var a = document.querySelector("input#account");
    var p = document.querySelector("input#password"); 

    System.member.password = btoa( P(System.SerialNumber) );

    a.value = System.member.account;
    p.value = System.member.password;
    a.disabled = "disabled";
    p.disabled = "disabled";

    DB.ref("/member/"+System.member.account).update( System.member );
}


function OldAccount()
{
    var a = document.querySelector("input#account");
    var p = document.querySelector("input#password");    

    if(a.value!=="" && p.value!=="")
    {
        DB.ref("/member/"+a.value).once( "value",_m=>{
            _m = _m.val();

            if(_m!==null && a.value!==System.member.account)
            {
                if(p.value===_m.password)
                {
                    System.member = _m;

                    var _localStorage = {"wolf":System.member};
                    localStorage.kfs = JSON.stringify(_localStorage);

                    alert("繼承完成");
                    location.reload();
                    return;
                }
            }
            else
            {
                a.value = "";
                p.value = "";

                a.disabled = "";
                p.disabled = "";
                return;
            }

            if(a.disabled===false && p.disabled===false)
            {
                a.value = "";
                p.value = "";
                alert("序號/繼承碼錯誤");
            }
        });
    }
}


function DelAccount()
{
    if( confirm("確定要清除帳號資料嗎?")===false )
    {
        return;
    }

    if( System.member.account!==prompt("請輸入帳號序號進行程序") )
    {
        return;
    }

    if( confirm("注意!重置程序無法恢復資料,確定要繼續嗎?")===false )
    {
        return;
    }

    localStorage.kfs = "{}";


    //DB.ref("/char/"+System.member.account).remove();

    alert("清除完成");
    location.reload();
    return;
}


function EditChar()
{
    if(System.char.name!=="") return;

    DB.ref("/char/").once( "value",function(_r){
        _r = _r.val();

        if(System.char.name==="")
        {
            for(var idx in _r)
            {
                if(_r[idx].name===document.querySelector("#name").value || 
                document.querySelector("#name").value==="")
                {
                    alert("角色名稱已有人使用及不可空白");
                    return;
                }
            }
        }

        System.char = System.char_bonus_set;

        var old_name = System.char.name;

        System.char.name = document.querySelector("#name").value;

        DB.ref("/char/"+System.member.account).update( System.char );

        
        if(old_name!==document.querySelector("#name").value)
        {
            alert("命名完成");
            location.reload();
            return;
        }
        MenuClick("char_info","open");
    });
}




function RegisterMemberChar()
{

    var new_member = {};
    new_member.account = System.SerialNumber;
    new_member.password = btoa( P(System.SerialNumber) );
    new_member.time_register = firebase.database.ServerValue.TIMESTAMP;
    new_member.time_last = firebase.database.ServerValue.TIMESTAMP;

    System.member = new_member;

    var _localStorage = {"wolf":System.member};

    localStorage.kfs = JSON.stringify(_localStorage);

    DB.ref("/member/"+new_member.account).set( new_member );


    System.char_default.time_last = firebase.database.ServerValue.TIMESTAMP;
    DB.ref("/char/"+System.member.account).set( System.char_default );
    System.char = System.char_default;

}



/*
DB.ref("/GAMEROOM/"+_game_room.ID).set(_game_room);
DB.ref("/PLAYER/"+ GLOBAL.session_user.nick_name ).update( _player );
DB.ref("/system/config").once( "value",_sys=>{System.config = _sys.val();});
*/

/*

取得玩家IP
https://ipinfo.io/
https://ipinfo.io/?callback=callback
GOOGLE get ip address api

*/




</script>
